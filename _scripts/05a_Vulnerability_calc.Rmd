---
title: "vulnerability"
author: "Leslie Roberson"
date: "07/02/2022"
output: html_document
---

Here I take the Productivity and Susceptibiltiy scores and calculate the Vulnerability score for each species (Euclidean distance between the 2 axes)

```{r setup, include=FALSE}

library(tidyverse)
library(pillar)
library(janitor)

knitr::opts_chunk$set(echo = TRUE)
```

load results

```{r load dat}

S <- read_csv(here("_results/Susceptibility/S_scores.csv"))
P <- read_csv(here("_results/Productivity/P_scores.csv"))
glimpse(S)
glimpse(P)

V <- left_join(S, P, by=c("species_id"="aquamaps_id"))
glimpse(V) # 730 rows
n_distinct(V$species_id) # 319
apply(is.na(V), 2, which) # no NAs

```

Calculate Euclidean distance

euclidean <- function(P, S) sqrt(sum((a - b)^2))
V is the Euclidean distance of the point (P, S)
#The adjustment for P occurs because high productivity is associated with low vulnerability (Grewelle et al 2022) > I do NOT do this because I switched the scores so that 1 is low risk and 3 is high risk for P traits

```{r Vuln calc}

glimpse(V)
V <- V %>% rename(S=geomean, P=productivity)
V$V <- sqrt(((V$P)^2 + V$S^2))

## get species info
spp.info <- read_excel(here("_data/spp_metadata.xlsx"))
glimpse(spp.info)
spp.info <- spp.info %>% 
  dplyr::select(c(species_id, sciname, class, grp_code, grp_name)) 

## Add species ranges and proportion range exposed to fishing
#for plotting and for sensitivity analysis
ranges <- read_csv(here("_data/species_ranges.csv"))
glimpse(ranges)
ranges <- ranges %>% mutate(species_id=stringr::str_replace_all(species_id, "_", "-"))

spp.info <- left_join(spp.info, ranges, by="species_id")
nrow(spp.info) # 405

V <- left_join(V, spp.info, by="species_id")
nrow(V) # 730

V %>%
  filter(gear=="GND") %>% 
  #filter(gear=="PST") %>% 
  #filter(gear=="LLT") %>% 
  dplyr::select(c(sciname_new, grp_code, S, P, V)) %>%
  arrange(desc(V)) %>% 
  head(20) 

write_csv(V, here("_results/Vulnerability/V_scores.csv"))
  
```

